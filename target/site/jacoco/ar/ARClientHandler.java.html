<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ARClientHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Projeto2-Grupo13</a> &gt; <a href="index.source.html" class="el_package">ar</a> &gt; <span class="el_source">ARClientHandler.java</span></div><h1>ARClientHandler.java</h1><pre class="source lang-java linenums">package ar;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import shared.CertificadoEleitor;
import shared.NetworkUtils;
import javax.net.ssl.SSLSocket;
import java.io.IOException;

/**
 * Thread responsável por processar requisições de clientes à Autoridade de Registo.
 * &lt;p&gt;
 * Aceita e trata três tipos de mensagens:
 * &lt;ul&gt;
 *   &lt;li&gt;Strings iniciadas com &quot;REVOGAR:&quot; para revogação de certificado&lt;/li&gt;
 *   &lt;li&gt;Instâncias de {@link CertificadoEleitor} para registro de eleitor&lt;/li&gt;
 *   &lt;li&gt;Qualquer outro tipo, resultando em erro de tipo inválido&lt;/li&gt;
 * &lt;/ul&gt;
 */

public class ARClientHandler extends Thread {
<span class="nc" id="L22">    private static final Logger logger = LogManager.getLogger(ARClientHandler.class);</span>
<span class="nc" id="L23">    private static final Logger securityLogger = LogManager.getLogger(&quot;SecurityLogger&quot;);</span>

    private final SSLSocket socket;
    private final AutoridadeRegisto ar;


    /**
     * Cria um novo handler para atender um cliente via socket SSL.
     *
     * @param socket conexão SSL com o cliente
     * @param ar     instância de {@link AutoridadeRegisto} para operações de registro/revogação
     */

<span class="nc" id="L36">    public ARClientHandler(SSLSocket socket, AutoridadeRegisto ar) {</span>
<span class="nc" id="L37">        this.socket = socket;</span>
<span class="nc" id="L38">        this.ar = ar;</span>
<span class="nc" id="L39">    }</span>


    /**
     * Processa a requisição do cliente:
     * &lt;ol&gt;
     *   &lt;li&gt;Recebe objeto via {@link NetworkUtils#receiveObject(SSLSocket)}&lt;/li&gt;
     *   &lt;li&gt;Se for String começando com &quot;REVOGAR:&quot;, chama {@link AutoridadeRegisto#revogarCertificado(String)}&lt;/li&gt;
     *   &lt;li&gt;Se for {@link CertificadoEleitor}, chama {@link AutoridadeRegisto#registarEleitor(CertificadoEleitor)}&lt;/li&gt;
     *   &lt;li&gt;Em outros casos, envia código de erro &quot;ERRO:TIPO_INVALIDO&quot;&lt;/li&gt;
     *   &lt;li&gt;Em caso de exceção, envia &quot;ERRO:&lt;mensagem&gt;&quot;&lt;/li&gt;
     * &lt;/ol&gt;
     * Após o tratamento, garante o fechamento do socket.
     */
    @Override
    public void run() {
        try {
<span class="nc" id="L56">            logger.debug(&quot;Iniciando handler para cliente: {}&quot;,</span>
<span class="nc" id="L57">                    socket.getInetAddress().getHostAddress());</span>

<span class="nc" id="L59">            Object input = NetworkUtils.receiveObject(socket);</span>

<span class="nc bnc" id="L61" title="All 4 branches missed.">            if (input instanceof String &amp;&amp; ((String) input).startsWith(&quot;REVOGAR:&quot;)) {</span>
<span class="nc" id="L62">                String idEleitor = ((String) input).split(&quot;:&quot;)[1];</span>
<span class="nc" id="L63">                ar.revogarCertificado(idEleitor);</span>
<span class="nc" id="L64">                NetworkUtils.sendObject(socket, &quot;CERTIFICADO_REVOGADO:&quot; + idEleitor);</span>
<span class="nc" id="L65">                logger.info(&quot;Certificado revogado para: {}&quot;, idEleitor);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            } else if (input instanceof CertificadoEleitor) {</span>
<span class="nc" id="L67">                CertificadoEleitor certificado = (CertificadoEleitor) input;</span>
<span class="nc" id="L68">                logger.info(&quot;Processando registro para: {}&quot;, certificado.getIdentificacao());</span>

<span class="nc" id="L70">                ar.registarEleitor(certificado);</span>
<span class="nc" id="L71">                NetworkUtils.sendObject(socket, certificado);</span>

<span class="nc" id="L73">                securityLogger.info(&quot;CERTIFICATE_ISSUED: {}&quot;, certificado.getIdentificacao());</span>
<span class="nc" id="L74">                logger.info(&quot;Registro concluído para: {}&quot;, certificado.getIdentificacao());</span>
<span class="nc" id="L75">            } else {</span>
<span class="nc" id="L76">                logger.warn(&quot;Tipo de objeto recebido inválido&quot;);</span>
<span class="nc" id="L77">                NetworkUtils.sendObject(socket, &quot;ERRO:TIPO_INVALIDO&quot;);</span>
            }
<span class="nc" id="L79">        } catch (Exception e) {</span>
<span class="nc" id="L80">            logger.error(&quot;Erro no handler do cliente: {}&quot;, e.getMessage(), e);</span>
            try {
<span class="nc" id="L82">                NetworkUtils.sendObject(socket, &quot;ERRO:&quot; + e.getMessage());</span>
<span class="nc" id="L83">            } catch (IOException ioException) {</span>
<span class="nc" id="L84">                logger.error(&quot;Falha ao enviar mensagem de erro&quot;, ioException);</span>
<span class="nc" id="L85">            }</span>
        } finally {
            try {
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (!socket.isClosed()) {</span>
<span class="nc" id="L89">                    socket.close();</span>
                }
<span class="nc" id="L91">            } catch (IOException e) {</span>
<span class="nc" id="L92">                logger.warn(&quot;Erro ao fechar socket: {}&quot;, e.getMessage());</span>
<span class="nc" id="L93">            }</span>
        }
<span class="nc" id="L95">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>